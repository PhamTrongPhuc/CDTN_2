<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>B√†i vi·∫øt chi ti·∫øt</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9fafb;
        }

        #post-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #post-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #post-author {
            font-size: 14px;
            color: gray;
            margin-bottom: 20px;
        }

        #post-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #post-content {
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        #reactions {
            margin-bottom: 30px;
        }

        #reactions button {
            margin-right: 8px;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #e5e7eb;
            transition: 0.2s;
        }

        #reactions button:hover {
            background: #d1d5db;
        }

        #reaction-counts {
            margin-top: 10px;
            font-size: 15px;
            color: #555;
        }

        #comments-section {
            margin-top: 40px;
        }

        #comments-list p {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 6px;
        }

        #comment-content {
            width: 100%;
            height: 80px;
            margin-top: 10px;
        }

        #submit-comment {
            margin-top: 10px;
            padding: 8px 14px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <a href="index.html">‚¨Ö Quay l·∫°i trang ch·ªß</a>

    <div id="post-container">
        <div id="post-title"></div>
        <div id="post-author"></div>
        <img id="post-image" src="" alt="">
        <div id="post-content"></div>

        <div id="reactions">
            <h3>Bi·ªÉu c·∫£m</h3>
            <button class="react-btn" data-type="like">üëç Th√≠ch</button>
            <button class="react-btn" data-type="love">‚ù§Ô∏è Y√™u th√≠ch</button>
            <button class="react-btn" data-type="haha">üòÇ Haha</button>
            <div id="reaction-counts"></div>
        </div>

        <div id="comments-section">
            <h3>B√¨nh lu·∫≠n</h3>
            <div id="comments-list">ƒêang t·∫£i b√¨nh lu·∫≠n...</div>
            <textarea id="comment-content" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."></textarea>
            <button id="submit-comment">G·ª≠i</button>
        </div>
    </div>
    <!-- N√∫t x√≥a b√†i vi·∫øt (ch·ªâ hi·ªán n·∫øu l√† t√°c gi·∫£) -->
    <button id="delete-post-btn" style="display:none; background-color:#e63946; color:white; 
               border:none; padding:8px 14px; border-radius:6px; 
               cursor:pointer; margin-top:10px;">
        üóëÔ∏è X√≥a b√†i vi·∫øt
    </button>
    <script>
        const postId = new URLSearchParams(window.location.search).get('id');
        const token = localStorage.getItem('token');

        // ============================
        // üîπ 1Ô∏è‚É£ L·∫•y chi ti·∫øt b√†i vi·∫øt
        // ============================
        async function loadPost() {
            try {
                const res = await fetch(`/api/posts/${postId}`);
                const post = await res.json();

                document.getElementById('post-title').textContent = post.title;
                document.getElementById('post-author').textContent = "T√°c gi·∫£: " + (post.author?.username || "·∫®n danh");
                document.getElementById('post-content').textContent = post.content;

                if (post.image) {
                    document.getElementById('post-image').src = post.image;
                    document.getElementById('post-image').style.display = 'block';
                } else {
                    document.getElementById('post-image').style.display = 'none';
                }

                // üßÆ C·∫≠p nh·∫≠t t·ªïng s·ªë c·∫£m x√∫c
                updateReactionCounts(post.reactions);

                // ‚úÖ Ki·ªÉm tra ng∆∞·ªùi d√πng hi·ªán t·∫°i c√≥ ph·∫£i t√°c gi·∫£ kh√¥ng
                if (token) {
                    // Th·ª≠ g·ªçi /api/auth/me n·∫øu API h·ªó tr·ª£
                    try {
                        const userRes = await fetch('/api/auth/me', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (userRes.ok) {
                            const user = await userRes.json();
                            if (user.id === post.author?._id) {
                                document.getElementById('delete-post-btn').style.display = 'inline-block';
                                // don't need to decode token
                                return;
                            }
                        }
                    } catch (e) {
                        // ignore
                    }

                    // N·∫øu kh√¥ng c√≥ endpoint /api/auth/me, decode token ·ªü client ƒë·ªÉ l·∫•y user id
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const userId = payload.id || payload._id || payload.userId || payload.sub || (payload._doc && (payload._doc.id || payload._doc._id));
                        // console.log('decoded payload', payload, 'userId:', userId, 'post.author:', post.author);
                        if (userId && post.author?._id && (userId === post.author._id.toString())) {
                            document.getElementById('delete-post-btn').style.display = 'inline-block';
                        }
                    } catch (e) {
                        // invalid token
                    }
                }

            } catch (err) {
                console.error("L·ªói khi t·∫£i b√†i vi·∫øt:", err);
            }
        }
        async function deleteComment(commentId) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?")) return;
            try {
                const res = await fetch(`/api/comments/${commentId}`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${token}` },
                });
                const data = await res.json();
                if (res.ok) {
                    alert(data.message);
                    loadComments(); // t·∫£i l·∫°i danh s√°ch b√¨nh lu·∫≠n
                } else {
                    alert(data.message || "Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n!");
                }
            } catch (err) {
                console.error("L·ªói khi x√≥a b√¨nh lu·∫≠n:", err);
            }
        }

        // ============================
        // üîπ 2Ô∏è‚É£ Hi·ªÉn th·ªã t·ªïng c·∫£m x√∫c
        // ============================
        function updateReactionCounts(reactions) {
            if (!reactions) return;
            const div = document.getElementById('reaction-counts');
            div.innerHTML = `
        üëç ${reactions.like || 0} &nbsp;
        ‚ù§Ô∏è ${reactions.love || 0} &nbsp;
        üòÇ ${reactions.haha || 0}
      `;
        }

        // ============================
        // üîπ 3Ô∏è‚É£ G·ª≠i c·∫£m x√∫c
        // ============================
        document.querySelectorAll('.react-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const reaction = btn.dataset.type;
                try {
                    const res = await fetch(`/api/posts/${postId}/react`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ reaction })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        updateReactionCounts(data.reactions);
                    } else {
                        alert(data.message || 'L·ªói khi g·ª≠i c·∫£m x√∫c!');
                    }
                } catch (err) {
                    console.error("L·ªói khi g·ª≠i c·∫£m x√∫c:", err);
                }
            });
        });

        // ============================
        // üîπ 4Ô∏è‚É£ B√¨nh lu·∫≠n
        // ============================
        async function loadComments() {
            try {
                const res = await fetch(`/api/comments/${postId}`);
                const comments = await res.json();
                const list = document.getElementById('comments-list');
                list.innerHTML = comments.length
                    ? comments.map(c => `<p><strong>${c.userId?.username || "·∫®n danh"}:</strong> ${c.content}</p>`).join('')
                    : "<p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>";
            } catch (err) {
                console.error("L·ªói khi t·∫£i b√¨nh lu·∫≠n:", err);
            }
        }

        document.getElementById('submit-comment').addEventListener('click', async () => {
            const content = document.getElementById('comment-content').value.trim();
            if (!content) return alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n!');
            try {
                const res = await fetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ postId, content })
                });
                if (res.ok) {
                    document.getElementById('comment-content').value = '';
                    loadComments();
                } else {
                    alert('‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n!');
                    window.location.href = 'login.html';
                }
            } catch (err) {
                console.error("L·ªói khi g·ª≠i b√¨nh lu·∫≠n:", err);
            }
        });

        // ============================
        // üîπ 5Ô∏è‚É£ Kh·ªüi ch·∫°y khi t·∫£i trang
        // ============================
        loadPost();
        loadComments();


        // ============================
        // üîπ 6Ô∏è‚É£ X·ª≠ l√Ω n√∫t X√≥a b√†i vi·∫øt
        // ============================
        document.getElementById('delete-post-btn').addEventListener('click', async () => {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i vi·∫øt n√†y kh√¥ng?")) return;
            try {
                const res = await fetch(`/api/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                alert(data.message || (res.ok ? 'X√≥a th√†nh c√¥ng' : 'L·ªói'));
                if (res.ok) {
                    window.location.href = 'index.html';
                }
            } catch (err) {
                console.error("L·ªói khi x√≥a b√†i vi·∫øt:", err);
            }
        });

    </script>
</body>

</html>